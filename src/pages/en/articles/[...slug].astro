---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { formatDate, t } from '../../../i18n/utils';

const locale = 'en' as const;

export async function getStaticPaths() {
  const textos = await getCollection('textos');

  // EN article pages: generate pages for EN articles + PT articles without translation
  const enArticles = textos.filter(texto => texto.data.lang === 'en');
  const enTranslationOfIds = new Set(enArticles.map(a => a.data.translationOf).filter(Boolean));
  const ptWithoutTranslation = textos.filter(
    texto => texto.data.lang !== 'en' && !enTranslationOfIds.has(texto.id)
  );

  const visibleArticles = [...enArticles, ...ptWithoutTranslation];

  return visibleArticles.map(texto => {
    const translation = textos.find(t => t.id === texto.data.translationOf);
    return {
      params: { slug: texto.id },
      props: { texto, translation },
    };
  });
}

const { texto, translation } = Astro.props;
const { Content } = await render(texto);
const articleLocale = texto.data.lang === 'en' ? 'en' : 'pt';
---

<BaseLayout title={`${texto.data.titulo} - Caio Leta`} description={texto.data.descricao}>
  <article class="max-w-3xl mx-auto px-6 pt-16 md:pt-24 pb-20">
    <header class="mb-10 fade-in">
      <div class="flex flex-wrap gap-2 mb-4">
        {texto.data.tags.map((tag: string) => (
          <span class="text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 text-primary/60 dark:text-dark-text/60">
            {tag}
          </span>
        ))}
      </div>
      <h1 class="font-serif text-3xl md:text-4xl lg:text-5xl font-bold leading-tight mb-4">
        {texto.data.titulo}
      </h1>
      <div class="flex items-center gap-3 text-sm text-primary/40 dark:text-dark-text/40">
        <time>{formatDate(texto.data.data, articleLocale as 'pt' | 'en')}</time>
        {texto.data.publicadoEm && (
          <>
            <span>&middot;</span>
            <span>{t(locale, 'articles.publishedAt')} {texto.data.publicadoEm}</span>
          </>
        )}
      </div>
      {texto.data.linkOriginal && (
        <a
          href={texto.data.linkOriginal}
          data-wayback={`https://web.archive.org/web/${texto.data.linkOriginal}`}
          target="_blank"
          rel="noopener noreferrer"
          class="original-link inline-block mt-3 text-sm text-accent dark:text-blue-400 hover:opacity-70 transition-opacity"
        >
          {t(locale, 'articles.viewOriginal')} &rarr;
        </a>
      )}
      {translation && (
        <a
          href={`/artigos/${translation.id}`}
          class="inline-block mt-3 ml-4 text-sm text-primary/50 dark:text-dark-text/50 hover:text-accent dark:hover:text-blue-400 transition-colors"
        >
          Ler em PortuguÃªs &rarr;
        </a>
      )}
    </header>

    <div class="prose fade-in">
      <Content />
    </div>

    <footer class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-800 fade-in">
      <a
        href="/en/articles"
        class="text-accent dark:text-blue-400 hover:opacity-70 transition-opacity text-sm"
      >
        &larr; {t(locale, 'articles.backToArticles')}
      </a>
    </footer>
  </article>

  <script>
    document.querySelectorAll('a.original-link').forEach(link => {
      link.addEventListener('click', async (e) => {
        const el = e.currentTarget as HTMLAnchorElement;
        const original = el.href;
        const wayback = el.dataset.wayback;
        if (!wayback) return;
        e.preventDefault();
        try {
          const res = await fetch(original, { method: 'HEAD', mode: 'no-cors' });
          window.open(original, '_blank');
        } catch {
          window.open(wayback, '_blank');
        }
      });
    });
  </script>
</BaseLayout>
